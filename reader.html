<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Lecture</title>
<link rel="stylesheet" href="/assets/style/style.css">
  <link rel="icon" type="image/png" href="/assets/img/favicon.png">
  <script src="/assets/js/auth.js"></script>

</head>

<body>

<header class="site-header">
  <div class="header-inner">
    <a href="index.html" class="logo">STARBORD</a>
    <div class="spacer"></div>
  </div>
</header>

<main class="reader-container">
  <div class="reader-toolbar">
    <h2 id="chapterTitle">Lecture</h2>
    <button class="reader-close" onclick="goBack()">âœ•</button>
  </div>

  <div class="reader-inner" id="pagesContainer"></div>
</main>

<!-- Bandeau chapitre suivant -->
<div id="nextChapterContainer" class="next-chapter-banner">
  <a id="nextChapterBtn" href="#">Chapitre suivant â†’</a>
</div>



<script>
  // Parse URL params
  const params = new URLSearchParams(window.location.search);
  const comicId = params.get('comic') || params.get('id') || null;
  const chapitreId = params.get('chapitre') || params.get('chapter') || null;
  const pagesContainer = document.getElementById('pagesContainer');

  // Exemple de structure de donnÃ©es
  const comicsData = {
    bd1: {
      title: "DÃ©tenu 278",
      chapters: {
        1: ["/assets/pages/detenu278/001.jpg", "/assets/pages/detenu278/002.jpg", "/assets/pages/detenu278/003.jpg", "/assets/pages/detenu278/004.jpg",
            "/assets/pages/detenu278/005.jpg", "/assets/pages/detenu278/006.jpg", "/assets/pages/detenu278/007.jpg", "/assets/pages/detenu278/008.jpg",
            "/assets/pages/detenu278/009.jpg", "/assets/pages/detenu278/010.jpg", "/assets/pages/detenu278/011.jpg", "/assets/pages/detenu278/012.jpg",
            "/assets/pages/detenu278/013.jpg", "/assets/pages/detenu278/014.jpg", "/assets/pages/detenu278/015.jpg", "/assets/pages/detenu278/016.jpg",
            "/assets/pages/detenu278/017.jpg", "/assets/pages/detenu278/018.jpg", "/assets/pages/detenu278/019.jpg" 
        ]
    }
    },
    bd2: {
      title: "FigÃ© dans l'acier",
      chapters: {
        1: ["/assets/pages/fige_dans_lacier/001.png", "/assets/pages/fige_dans_lacier/002.png", "/assets/pages/fige_dans_lacier/003.png", "/assets/pages/fige_dans_lacier/004.png",
            "/assets/pages/fige_dans_lacier/005.png", "/assets/pages/fige_dans_lacier/006.png", "/assets/pages/fige_dans_lacier/007.png", "/assets/pages/fige_dans_lacier/008.png",
            "/assets/pages/fige_dans_lacier/009.png", "/assets/pages/fige_dans_lacier/010.png", "/assets/pages/fige_dans_lacier/011.png", "/assets/pages/fige_dans_lacier/012.png",
            "/assets/pages/fige_dans_lacier/013.png", "/assets/pages/fige_dans_lacier/014.png", "/assets/pages/fige_dans_lacier/015.png"  
        ]
      }
    }
  };

  // Affichage des pages
// ðŸ”’ Gestion Freemium
const FREE_PAGES_LIMIT = 5;

if (comicId && chapitreId && comicsData[comicId] && comicsData[comicId].chapters[chapitreId]) {
  const pages = comicsData[comicId].chapters[chapitreId];
  const isLogged = Auth.isLoggedIn(); // VÃ©rifie token

  pages.forEach((src, index) => {

    // âœ… Pages gratuites
    if (index < FREE_PAGES_LIMIT) {
      const img = document.createElement('img');
      img.src = src;
      img.className = 'page-img';
      pagesContainer.appendChild(img);
    }

    // ðŸ”’ Pages premium
    else {
      if (isLogged) {
        const img = document.createElement('img');
        img.src = src;
        img.className = 'page-img';
        pagesContainer.appendChild(img);
      } else {
        const lock = document.createElement('div');
        lock.className = 'premium-lock';
        lock.innerHTML = `
          <p>ðŸ”’ Connecte-toi pour lire la suite</p>
          <a href="login.html" class="login-btn">Se connecter</a>
        `;
        pagesContainer.appendChild(lock);

        return; // Stop aprÃ¨s le message premium
      }
    }

  });

} else {
  pagesContainer.innerHTML = "<p>Aucune page disponible pour ce chapitre.</p>";
}



  // debug
  console.log('comicId=', comicId, 'chapitreId=', chapitreId);

  // Fonction goBack
  function goBack() {
    try {
      const ref = document.referrer || '';
      if (ref.includes('chapitre') || ref.includes('chapters') || ref.includes('chapitre.html')) {
        history.back();
        setTimeout(() => {
          if (document.location.href.indexOf('reader/reader.html') !== -1) fallbackRedirect();
        }, 300);
        return;
      }
    } catch(e){}
    fallbackRedirect();
  }

  function fallbackRedirect() {
    if (comicId) {
      window.location.href = '../chapitre.html?comic=' + encodeURIComponent(comicId);
    } else {
      window.location.href = '../index.html';
    }
  }

  // Titre
  const titleEl = document.getElementById('chapterTitle');
  if (titleEl) {
    if (chapitreId) titleEl.textContent = 'Chapitre ' + chapitreId;
    else if (comicId) titleEl.textContent = 'Lecture â€” ' + comicId;
  }

  // Nombre total de chapitres
  const totalChapters = comicsData[comicId] ? Object.keys(comicsData[comicId].chapters).length : 0;

  function showNextChapterButton() {
    if (!chapitreId || !totalChapters) return;
    const current = parseInt(chapitreId, 10);
    if (current < totalChapters) {
      const nextContainer = document.getElementById("nextChapterContainer");
      const nextBtn = document.getElementById("nextChapterBtn");
      if (nextContainer && nextBtn) {
        nextBtn.href = `reader.html?comic=${comicId}&chapitre=${current + 1}`;
        nextContainer.classList.add("show");
      }
    }
  }

  // DÃ©tection fin scroll
  pagesContainer.addEventListener("scroll", () => {
    if (pagesContainer.scrollTop + pagesContainer.clientHeight >= pagesContainer.scrollHeight - 10) {
      showNextChapterButton();
    } else {
      const nextContainer = document.getElementById("nextChapterContainer");
      if (nextContainer) nextContainer.classList.remove("show");
    }
  });

  /* --- PROTECTION CONTRE COPIE / SCREENSHOT --- */

// DÃ©sactiver clic droit
document.addEventListener('contextmenu', e => e.preventDefault());

// Bloquer certaines touches clavier
document.addEventListener('keydown', e => {
  // Print Screen
  if (e.key === 'PrintScreen') {
    e.preventDefault();
    alert("La capture d'Ã©cran est dÃ©sactivÃ©e.");
  }

  // Ctrl + S / Ctrl + C / Ctrl + P / Ctrl + U
  if (e.ctrlKey && ['s','c','p','u'].includes(e.key.toLowerCase())) {
    e.preventDefault();
  }
});

document.addEventListener("visibilitychange", () => {
  const reader = document.querySelector(".reader-container");

  if (document.hidden) {
    reader.style.filter = "blur(20px)";
  } else {
    reader.style.filter = "none";
  }
});

document.addEventListener('touchstart', e => {
  if (e.touches.length > 1) e.preventDefault();
}, { passive: false });


function addWatermark() {
  const wm = document.createElement('div');
  wm.style.position = "fixed";
  wm.style.top = "50%";
  wm.style.left = "50%";
  wm.style.transform = "translate(-50%, -50%) rotate(-30deg)";
  wm.style.opacity = "0.15";
  wm.style.fontSize = "48px";
  wm.style.pointerEvents = "none";
  wm.style.zIndex = "9999";
  document.body.appendChild(wm);
}

addWatermark();


</script>

</body>
</html>
